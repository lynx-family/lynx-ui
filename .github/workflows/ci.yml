name: Test
on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - "**/*.{md,mdx}"
  merge_group:
    types: [checks_requested]
permissions:
  repository-projects: read
  contents: read
  statuses: read
  pull-requests: read

env:
  CI: 1
  TURBO_TELEMETRY_DISABLED: 1
concurrency:
  group: ${{ github.event_name }}-${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true
jobs:
  build:
    uses: ./.github/workflows/build.yml
  code-style-check:
    runs-on: lynx-ubuntu-24.04-medium
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
        with:
          node-version: "20"
          package-manager-cache: false
      - name: Install
        run: |
          git submodule update --init --recursive --remote
          npm install -g corepack@latest
          corepack enable
          pnpm install --frozen-lockfile
      - name: Code Style Check
        run: |
          pnpm dprint check
          pnpm biome check
          pnpm dlx sherif@latest
      - name: Changeset Check
        run: pnpm changeset status --since=origin/main

  eslint:
    needs: build
    uses: ./.github/workflows/common-test.yml
    with:
      runs-on: lynx-ubuntu-24.04-medium
      run: pnpm eslint . --flag v10_config_lookup_from_file

  test-publish:
    needs: build
    uses: ./.github/workflows/common-test.yml
    secrets: inherit
    with:
      runs-on: lynx-ubuntu-24.04-medium
      run: |
        # Start Verdaccio
        pnpm dlx verdaccio@5 -c tools/verdaccio/config.yaml &

        # Wait for Verdaccio to start
        sleep 10

        printf '\n//localhost:4873/:_authToken="this-is-a-fake-token"\n' >> ~/.npmrc
        pnpm changeset version --snapshot regression
        node tools/canary-release/snapshot.js
        pnpm --recursive publish --no-git-checks --access public --registry=http://localhost:4873
        PKG_NAME=$(node -p "require('./packages/lynx-ui-button/package.json').name")
        PKG_VERSION=$(node -p "require('./packages/lynx-ui-button/package.json').version")
        echo "Testing $PKG_NAME@$PKG_VERSION"
        cd `mktemp -d`
        mkdir smoke-test
        cd smoke-test
        pnpm init
        echo "registry=http://localhost:4873" > .npmrc
        pnpm add $PKG_NAME@$PKG_VERSION
         if [ ! -f "node_modules/$PKG_NAME/package.json" ]; then
           echo "Package failed to install"
           exit 1
         fi
         MAIN_FILE=$(node -p "require('./node_modules/$PKG_NAME/package.json').main")
         if [ ! -f "node_modules/$PKG_NAME/$MAIN_FILE" ]; then
            echo "Main file not found: $MAIN_FILE"
            exit 1
         fi
        echo "Smoke test passed for $PKG_NAME"

  test-typos:
    runs-on: lynx-ubuntu-24.04-medium
    steps:
      - uses: actions/checkout@v4
      - uses: crate-ci/typos@2d0ce569feab1f8752f1dde43cc2f2aa53236e06 # v1.40.0
        with:
          files: .
  test-vitest:
    needs: build
    uses: ./.github/workflows/common-test.yml
    strategy:
      fail-fast: false
      matrix:
        runs-on:
          - name: Ubuntu
            label: lynx-ubuntu-24.04-medium
    name: Vitest (${{ matrix.runs-on.name }})
    with:
      runs-on: ${{ matrix.runs-on.label }}
      run: >
        pnpm run test
        --reporter=github-actions
        --reporter=dot
        --reporter=junit
        --outputFile=test-report.junit.xml
        --expect.poll.timeout=5000
        --testTimeout=50000
        --hookTimeout=50000
        --coverage
        --coverage.reporter='json'
        --coverage.reporter='text'
        --no-cache
        --logHeapUsage
        --silent
  done:
    needs:
      - code-style-check
      - eslint
      - test-publish
      - test-typos
      - test-vitest
    if: always()
    runs-on: ubuntu-latest
    name: Done
    steps:
      - run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'skipped') || contains(needs.*.result, 'cancelled')) }}
